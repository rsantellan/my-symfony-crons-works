(function($){$.fn.autoSuggest=function(L,M){var N={asHtmlID:false,startText:"Enter Name Here",emptyText:"No Results Found",preFill:{},limitText:"No More Selections Are Allowed",selectedItemProp:"value",selectedValuesProp:"value",searchObjProps:"value",queryParam:"q",retrieveLimit:false,extraParams:"",matchCase:false,minChars:1,keyDelay:400,resultsHighlight:true,neverSubmit:false,selectionLimit:false,showResultList:true,showTags:true,start:function(){},selectionClick:function(a){},selectionAdded:function(a){},selectionRemoved:function(a){a.remove()},formatList:false,beforeRetrieve:function(a){return a},retrieveComplete:function(a){return a},resultClick:function(a){},resultsComplete:function(){}};var O=$.extend(N,M);var P="object";var Q=0;if(typeof L=="string"){P="string";var R=L}else{var S=L;for(k in L)if(L.hasOwnProperty(k))Q++}if((P=="object"&&Q>0)||P=="string"){return this.each(function(x){if(!O.asHtmlID){x=x+""+Math.floor(Math.random()*100);var q="as-input-"+x}else{x=O.asHtmlID;var q=x}O.start.call(this);var r=$(this);r.attr("autocomplete","off").addClass("as-input").attr("id",q).val(O.startText);var s=false;r.wrap('<ul class="as-selections" id="as-selections-'+x+'"></ul>').wrap('<li class="as-original" id="as-original-'+x+'"></li>');var t=$("#as-selections-"+x);var u=$("#as-original-"+x);var v=$('<div class="as-results" id="as-results-'+x+'"></div>').hide();var w=$('<ul class="as-list"></ul>');var z=$('<input type="hidden" class="as-values" name="as_values_'+x+'" id="as-values-'+x+'" />');var A="";if(typeof O.preFill=="string"){var B=O.preFill.split(",");for(var i=0;i<B.length;i++){var C={};C[O.selectedValuesProp]=B[i];if(B[i]!=""){add_selected_item(C,"000"+i)}}A=O.preFill}else{A="";var D=0;for(k in O.preFill)if(O.preFill.hasOwnProperty(k))D++;if(D>0){for(var i=0;i<D;i++){var E=O.preFill[i][O.selectedValuesProp];if(E==undefined){E=""}A=A+E+",";if(E!=""){add_selected_item(O.preFill[i],"000"+i)}}}}if(A!=""){r.val("");var F=A.substring(A.length-1);if(F!=","){A=A+","}z.val(","+A);$("li.as-selection-item",t).addClass("blur").removeClass("selected")}r.after(z);t.click(function(){s=true;r.focus()}).mousedown(function(){s=false}).after(v);var G=null;var H="";var I=0;var J=false;r.focus(function(){if($(this).val()==O.startText&&z.val()==""){$(this).val("")}else if(s){$("li.as-selection-item",t).removeClass("blur");if($(this).val()!=""){w.css("width",t.outerWidth());v.show()}}s=true;return true}).blur(function(){if($(this).val()==""&&z.val()==""&&A==""){$(this).val(O.startText)}else if(s){$("li.as-selection-item",t).addClass("blur").removeClass("selected");v.hide()}}).keydown(function(e){lastKeyPressCode=e.keyCode;first_focus=false;switch(e.keyCode){case 38:e.preventDefault();moveSelection("up");break;case 40:e.preventDefault();moveSelection("down");break;case 8:if(r.val()==""){var a=z.val().split(",");a=a[a.length-2];t.children().not(u.prev()).removeClass("selected");if(u.prev().hasClass("selected")){z.val(z.val().replace(","+a+",",","));O.selectionRemoved.call(this,u.prev())}else{O.selectionClick.call(this,u.prev());u.prev().addClass("selected")}}if(r.val().length==1){v.hide();H=""}if($(":visible",v).length>0){if(G){clearTimeout(G)}G=setTimeout(function(){keyChange()},O.keyDelay)}break;case 9:case 188:J=true;var b=r.val().replace(/(,)/g,"");if(b!=""&&z.val().search(","+b+",")<0&&b.length>=O.minChars){e.preventDefault();var c={};c[O.selectedItemProp]=b;c[O.selectedValuesProp]=b;var d=$("li",t).length;r.val("")}case 13:J=false;var f=$("li.active:first",v);if(f.length>0){f.click();v.hide()}if(O.neverSubmit||f.length>0){e.preventDefault()}break;default:if(O.showResultList){if(O.selectionLimit&&$("li.as-selection-item",t).length>=O.selectionLimit){w.html('<li class="as-message">'+O.limitText+'</li>');v.show()}else{if(G){clearTimeout(G)}G=setTimeout(function(){keyChange()},O.keyDelay)}}break}});function keyChange(){if(lastKeyPressCode==46||(lastKeyPressCode>8&&lastKeyPressCode<32)){return v.hide()}var c=r.val().replace(/[\\]+|[\/]+/g,"");if(c==H)return;H=c;if(c.length>=O.minChars){t.addClass("loading");if(P=="string"){var d="";if(O.retrieveLimit){d="&limit="+encodeURIComponent(O.retrieveLimit)}if(O.beforeRetrieve){c=O.beforeRetrieve.call(this,c)}$.getJSON(R+"?"+O.queryParam+"="+encodeURIComponent(c)+d+O.extraParams,function(a){Q=0;var b=O.retrieveComplete.call(this,a);for(k in b)if(b.hasOwnProperty(k))Q++;processData(b,c)})}else{if(O.beforeRetrieve){c=O.beforeRetrieve.call(this,c)}processData(S,c)}}else{t.removeClass("loading");v.hide()}}var K=0;function processData(d,e){if(!O.matchCase){e=e.toLowerCase()}var f=0;v.html(w.html("")).hide();for(var i=0;i<Q;i++){var g=i;K++;var h=false;if(O.searchObjProps=="value"){var j=d[g].value}else{var j="";var k=O.searchObjProps.split(",");for(var y=0;y<k.length;y++){var l=$.trim(k[y]);j=j+d[g][l]+" "}}if(j){if(!O.matchCase){j=j.toLowerCase()}var m=new RegExp(",?"+d[g][O.selectedValuesProp]+",");if(j.search(e)!=-1&&z.val().search(m)==-1){h=true}}if(h){var n=$('<li class="as-result-item" id="as-result-item-'+g+'"></li>').click(function(){var a=$(this).data("data");var b=a.num;if($("#as-selection-"+b,t).length<=0&&!J){var c=a.attributes;r.val("").focus();H="";add_selected_item(c,b);O.resultClick.call(this,a);v.hide()}J=false}).mousedown(function(){s=false}).mouseover(function(){$("li",w).removeClass("active");$(this).addClass("active")}).data("data",{attributes:d[g],num:K});var o=$.extend({},d[g]);if(!O.matchCase){var p=new RegExp("(?![^&;]+;)(?!<[^<>]*)("+e+")(?![^<>]*>)(?![^&;]+;)","gi")}else{var p=new RegExp("(?![^&;]+;)(?!<[^<>]*)("+e+")(?![^<>]*>)(?![^&;]+;)","g")}if(O.resultsHighlight){o[O.selectedItemProp]=o[O.selectedItemProp].replace(p,"<em>$1</em>")}if(!O.formatList){n=n.html(o[O.selectedItemProp])}else{n=O.formatList.call(this,o,n)}w.append(n);delete o;f++;if(O.retrieveLimit&&O.retrieveLimit==f){break}}}t.removeClass("loading");if(f<=0){w.html('<li class="as-message">'+O.emptyText+'</li>')}w.css("width",t.outerWidth());v.show();O.resultsComplete.call(this)}function add_selected_item(b,c){if(O.showTags){z.val(z.val()+b[O.selectedValuesProp]+",");var d=$('<li class="as-selection-item" id="as-selection-'+c+'"></li>').click(function(){O.selectionClick.call(this,$(this));t.children().removeClass("selected");$(this).addClass("selected")}).mousedown(function(){s=false});var e=$('<a class="as-close">&times;</a>').click(function(){var a=new RegExp(",?"+b[O.selectedValuesProp]+",");z.val((z.val().replace(a,",")==","?"":z.val().replace(a,",")));O.selectionRemoved.call(this,d);s=true;r.focus();return false});u.before(d.html(b[O.selectedItemProp]).prepend(e));O.selectionAdded.call(this,u.prev())}}function moveSelection(a){if($(":visible",v).length>0){var b=$("li",v);if(a=="down"){var c=b.eq(0)}else{var c=b.filter(":last")}var d=$("li.active:first",v);if(d.length>0){if(a=="down"){c=d.next()}else{c=d.prev()}}b.removeClass("active");c.addClass("active")}}})}}})(jQuery);